<h1 class="c75 c35" id="h.5yohiqb4mhvt"><span class="c28 c87"></span></h1><h1 class="c95 c35" id="h.j74nqk8f0mt0"><span class="c28 c87">Epis&oacute;dio 19: Conhecendo o m&oacute;dulo CCP - Modo de Modula&ccedil;&atilde;o por Largura de Pulso (PWM)</span></h1><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>Neste episodio falaremos sobre o ultimo modo sobre o modulo CCP. O modo abordado neste episodio sera o modo PWM</span><sup><a href="#ftnt1" id="ftnt_ref1">[1]</a></sup><span class="c5">(Pulse Width Modulation - Modula&ccedil;&atilde;o por Largura de Pulso) sobre o pino RB3 que deve ser configurado como pino de sa&iacute;da.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">A configura&ccedil;&atilde;o do registrador CCP1CON para trabalhar no modo PWM &eacute; dada pela Tabela X1.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c34">Tabela X1 -</span><span class="c5">Bits de sele&ccedil;&atilde;o do modo PWM</span></p><a id="t.7edab6bfd70b3c8b4909ec3ef098ee8f88563ee0"></a><a id="t.155"></a><table class="c7"><tbody><tr class="c21"><td class="c72"><p class="c1"><span class="c26">CCP1M3</span></p></td><td class="c72"><p class="c1"><span class="c26">CCP1M2</span></p></td><td class="c72"><p class="c1"><span class="c26">CCP1M1</span></p></td><td class="c72"><p class="c1"><span class="c26">CCP1M0</span></p></td><td class="c112"><p class="c1"><span class="c26">Fun&ccedil;&atilde;o</td>
</tr>
<tr class="c21"><td class="c72"><p class="c1"><span class="c5">0</span></p></td><td class="c72"><p class="c1"><span class="c5">0</span></p></td><td class="c72"><p class="c1"><span class="c5">0</span></p></td><td class="c72"><p class="c1"><span class="c5">0</span></p></td><td class="c112"><p class="c1"><span class="c5">desliga o modoPWM</td>
</tr>
<tr class="c21"><td class="c72"><p class="c1"><span class="c5">1</span></p></td><td class="c72"><p class="c1"><span class="c5">1</span></p></td><td class="c72"><p class="c1"><span class="c5">x</span></p></td><td class="c72"><p class="c1"><span class="c5">x</span></p></td><td class="c112"><p class="c1"><span class="c5">liga (ativa) modo PWM</span></p></td></tr></tbody></table><p class="c12 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Conforme Figura X1, a configura&ccedil;&atilde;o &eacute; feita sobre os registradores CCPR1L, os bits CCP1X e CCP1Y (do registrador CCP1CON) e PR2. Tamb&eacute;m h&aacute; a necessidade do Prescaler do Timer2.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Uma sa&iacute;da PWM no pino RB3/CCP1 &eacute; dada pela Figura X2, e assim o calculo do periodo PWM em segundos &eacute; dada pela equa&ccedil;&atilde;o</span></p><p class="c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 556.00px; height: 75.00px;"><img alt="" src="images/image60.png" style="width: 556.00px; height: 75.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c11"><span class="c5">A frequencia PWM &eacute; dada por</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c5">frequencia PWM = 1 / (PWM period)</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Se o valor do registrador TMR2 for igual ao valor do registrador PR2, podem ocorrer 3 eventos no proximo ciclo de incremento</span></p><ul class="c80 lst-kix_uq15rfd2l17e-0 start"><li class="c31"><span class="c5">o registrador TMR2 &eacute; limpo;</span></li><li class="c31"><span class="c5">O pino RB3/CCP1 est&aacute; setado (excess&atilde;o: Se o dutty cycle for igual a 0%, o pino RB3/CCP1 n&atilde;o ser&aacute; setado);</span></li><li class="c31"><span class="c5">O dutty cycle do sinal PWm &eacute; colocado do registrador CCPR1L dentro do registrador CCPR1H.</span></li></ul><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">O dutty cycle PWM em segundos &eacute; calculado por</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 531.00px; height: 120.00px;"><img alt="" src="images/image3.png" style="width: 531.00px; height: 120.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>Note que CCPR1L:CCP1CON&lt;5:4&gt; gera um numero de 10 bits, logo cada intervalo ser&aacute; de V</span><span class="c62">DD</span><span class="c5">/1024.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">A maxima resolu&ccedil;&atilde;o PWM em bits para uma frequencia PWM</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 520.00px; height: 110.00px;"><img alt="" src="images/image26.png" style="width: 520.00px; height: 110.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Conforme o datasheet, o processo de configura&ccedil;&atilde;o da opera&ccedil;&atilde;o PWM &eacute;:</span></p><ol class="c80 lst-kix_n6uxz2i6taog-0 start" start="1"><li class="c31"><span class="c5">Configure o periodo do PWM escrevendo-se no registrador PR2;</span></li><li class="c31"><span class="c5">Configure o dutty cycle do PWM escrevendo-se no registrador CCPR1L e CCP1CON&lt;5:4&gt;;</span></li><li class="c31"><span class="c5">Fa&ccedil;a o pino RB3/CCP1 como pino de sa&iacute;da, limpando o bit TRISB&lt;3&gt;;</span></li><li class="c31"><span class="c5">Configure o vlaor do Prescaler de TMR2 e ative o TImer2 ativando escrevendo em T2CON.</span></li></ol><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>Vejamos um exemplo para f</span><span class="c62">osc</span><span class="c5">=20 MHz, Timer Prescaler=16 e PR2=0xFF</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c2">Periodo PWM = (PR2 + 1) * 4 * Tosc * (Timer2 Prescaler)</span></p><p class="c11"><span class="c2">      = (255 + 1) * 4 * (1/20*10^6) * 16</span></p><p class="c11"><span class="c2">      = (256 * 16 * 10^-6)/5</span></p><p class="c11"><span class="c2">      = 819,2 * 10^-6 s</span></p><p class="c11"><span class="c2">      = 819,2 &mu;s</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c2">Frequencia PWM = 1 / (Periodo PWM)</span></p><p class="c11"><span class="c2">       = 1 / (819,2 &mu;s)</span></p><p class="c11"><span class="c2">       = 1 / (819,2 * 10^-6 s)</span></p><p class="c11"><span class="c2">       = 1220,703125 Hz</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Como a tens&atilde;o VDD = 5 V, se quisermos aproximadamente 1,7 V na saida (pino RB3/CCP1) teremos que aplicar uma regra de 3</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c24"><span class="c2">5,0 V      1023</span></p><p class="c24"><span class="c2">1,7 V      n</span></p><p class="c24 c14"><span class="c2"></span></p><p class="c24"><span class="c2">5 V / 1,7 V = 1023 / n</span></p><p class="c24 c14"><span class="c2"></span></p><p class="c24"><span class="c2">n = (1,7 V / 5 V) * 1023</span></p><p class="c24"><span class="c2">n = 347,82</span></p><p class="c24 c14"><span class="c2"></span></p><p class="c24"><span class="c2">Por&eacute;m esse valor deve ser um numero natural, assim temos dois casos a analizar:</span></p><ul class="c80 lst-kix_d0ecpr1v4udn-0 start"><li class="c24 c31 li-bullet-0"><span class="c2">n = 347, tem-se </span></li></ul><p class="c24 c49 c14"><span class="c2"></span></p><p class="c24 c23"><span class="c2">(5 V * (347 / 1023)) = 1,696 V</span></p><p class="c24 c14"><span class="c2"></span></p><ul class="c80 lst-kix_d0ecpr1v4udn-0"><li class="c24 c31 li-bullet-0"><span class="c2">n = 348, tem-se</span></li></ul><p class="c24 c49 c14"><span class="c2"></span></p><p class="c24 c23"><span class="c2">(5 V * (348 / 1023)) = 1,701 V</span></p><p class="c24 c14"><span class="c2"></span></p><p class="c11"><span class="c5">Supondo que queiramos fazer uso do valor 347, assim</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span>347</span><span class="c62">10</span><span>= 0101.0110.11</span><span class="c62">2</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Os dados para o dutty cycle PWM &eacute;</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c8">CCPR1L:CCP1CON&lt;5:4&gt; = 0101.0110.11</span><span class="c63 c8 c62 c53">2</span></p><p class="c11"><span class="c8">      CCPR1L = 0101.0110</span><span class="c63 c8 c62 c53">2</span></p><p class="c11"><span class="c8">   CCP1CON&lt;5:4&gt; = 11</span><span class="c63 c8 c62 c53">2</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Assim o dutty cycle PWM em segundos &eacute;</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c2">dutty cycle PWM = (347 / 1023) * Periodo PWM</span></p><p class="c11"><span class="c2">        = (347 / 1023) * 819,2 * 10^-6 s</span></p><p class="c11"><span class="c2">        = 277,871 * 10^-6 s</span></p><p class="c11"><span class="c8">        = 277,871 &mu;s</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c5">A m&aacute;xima resolu&ccedil;&atilde;o PWM &eacute;</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c2">max. resolu&ccedil;&atilde;o PWM = log( fosc / (fPWM * TMR2 Prescaler) ) / log(2)</span></p><p class="c11"><span class="c2">         = log( (20 * 10^6) / (1220,703125 * 16) ) / log(2)</span></p><p class="c11"><span class="c2">         = log( 1024 ) / log(2)</span></p><p class="c11"><span class="c2">         = 10 bits</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>A Tabela X3 mostra exemplos de frequencias e resolu&ccedil;&otilde;es PWM para f</span><span class="c62">osc</span><span>= 20 MHz</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c34">Tabela X3 -</span><span class="c5">Tabela de frequencias e resolu&ccedil;&atilde;o para fosc = 20 MHz</span></p><a id="t.2639c2ef66086096e2edf254bc287943df9c26a5"></a><a id="t.156"></a><table class="c56"><tbody><tr class="c21"><td class="c82"><p class="c1 c14"><span class="c5"></span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 1</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 2</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 3</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 4</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 5</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 6</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Timer Prescaler TMR2</span></p></td><td class="c82"><p class="c1"><span class="c5">16</span></p></td><td class="c82"><p class="c1"><span class="c5">4</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">PR2</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0x3F</span></p></td><td class="c82"><p class="c1"><span class="c5">0x1F</span></p></td><td class="c82"><p class="c1"><span class="c5">0x17</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Frequ&ecirc;ncia PWM</span></p></td><td class="c82"><p class="c1"><span class="c5">1,22 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">4,88 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">19,53 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">78,12 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">153,3 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">208,3 kHz</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Maxima Resolu&ccedil;&atilde;o PWM</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">8</span></p></td><td class="c82"><p class="c1"><span class="c5">7</span></p></td><td class="c82"><p class="c1"><span class="c5">6,5</span></p></td></tr></tbody></table><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">A Tabela X4 mostra exemplos de frequencias e resolu&ccedil;&otilde;es PWM para fosc = 4 MHz</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c34">Tabela X -</span><span class="c5">Tabela de frequencias e resolu&ccedil;&atilde;o para fosc = 4 MHz</span></p><a id="t.9744092ef880f560735c75626ed4ec0373b16041"></a><a id="t.157"></a><table class="c56"><tbody><tr class="c21"><td class="c82"><p class="c1 c14"><span class="c5"></span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 1</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 2</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 3</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 4</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 5</span></p></td><td class="c82"><p class="c1"><span class="c26">Exemplo 6</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Timer Prescaler TMR2</span></p></td><td class="c82"><p class="c1"><span class="c5">16</span></p></td><td class="c82"><p class="c1"><span class="c5">4</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</span></p></td><td class="c82"><p class="c1"><span class="c5">1</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">PR2</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0xFF</span></p></td><td class="c82"><p class="c1"><span class="c5">0x3F</span></p></td><td class="c82"><p class="c1"><span class="c5">0x1F</span></p></td><td class="c82"><p class="c1"><span class="c5">0x17</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Frequ&ecirc;ncia PWM</span></p></td><td class="c82"><p class="c1"><span class="c5">244,14 Hz</span></p></td><td class="c82"><p class="c1"><span class="c5">976,56 Hz</span></p></td><td class="c82"><p class="c1"><span class="c5">3,91 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">15,62 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">31,25 kHz</span></p></td><td class="c82"><p class="c1"><span class="c5">41,66 kHz</td>
</tr>
<tr class="c21"><td class="c82"><p class="c1"><span class="c26">Maxima Resolu&ccedil;&atilde;o PWM</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">10</span></p></td><td class="c82"><p class="c1"><span class="c5">8</span></p></td><td class="c82"><p class="c1"><span class="c5">7</span></p></td><td class="c82"><p class="c1"><span class="c5">6,6</span></p></td></tr></tbody></table><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c42 c39 c34 c50">Exemplo de aplica&ccedil;&atilde;o</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c42 c39 c34 c50">Codigo</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c34">Figura X1 -</span><span class="c5">Diagrama de bloco de opera&ccedil;&atilde;o do modo de PWM</span></p><p class="c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 561.00px; height: 500.00px;"><img alt="" src="images/image57.png" style="width: 561.00px; height: 500.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c34">Figura X2 -</span><span class="c5">Saida PWM</span></p><p class="c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 531.00px; height: 294.00px;"><img alt="" src="images/image80.png" style="width: 531.00px; height: 294.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><hr style="page-break-before:always;display:none;">