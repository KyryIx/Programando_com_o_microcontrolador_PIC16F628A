<p class="c11 c14"><span class="c5"></span></p><h1 class="c95 c35" id="h.9jbmwmyno0j"><span class="c28 c87">Epis&oacute;dio 14: Conhecendo a interrup&ccedil;&atilde;o por estouro em Timer0 (registrador TMR0 de 8 bits) de 8 bits no PIC16F628A</span></h1><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Neste episodio veremos o uso do registrador TMR0 e da interrup&ccedil;&atilde;o associada a ele no qual pode ser usado em rotinas de temporizadores (contadores de tempo) mais precisos quanto tamb&eacute;m contadores associado ao pino RA4/T0CKI.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">O registrador TMR0 SEMPRE &eacute; incrementado e cabe ao desenvolvedor do software fazer a escolha por incremento por pulso externo dado no pino RA4/T0CKI ou por um incremento dado por ciclo de instru&ccedil;&atilde;o.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">O registrador TMR0 pode ser zerado (limpo - clear) usando a instru&ccedil;&atilde;o</span></p><p class="c12"><span class="c5">CLRF TMR0</span></p><p class="c11"><span class="c5">como tamb&eacute;m pode ser atualizado para um valor pelas instru&ccedil;&otilde;es</span></p><p class="c12"><span class="c5">MOVLW  0x0A</span></p><p class="c12"><span class="c5">MOVWF  TMR0</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">A escolha para a defini&ccedil;&atilde;o de qual ser&aacute; a fonte de incremento &eacute; dada por</span></p><ul class="c80 lst-kix_rfoy0kcgwpz6-0 start"><li><span class="c5">externa no pino RA4/T0CKI</span></li></ul><p class="c11"><span>      </span><span class="c2">BSF OPTION_REG, T0CS</span></p><p class="c11"><span class="c2">      ; incremento na transicao de alto para baixo</span></p><p class="c11"><span class="c2">      ; sobre o pino RA4/T0CKI</span></p><p class="c11"><span class="c2">      BSF OPTION_REG, T0SE</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c5">ou</span></p><p class="c11"><span>      </span><span class="c2">BSF OPTION_REG, T0CS</span></p><p class="c11"><span class="c2">      ; incremento na transicao de baixo para alto</span></p><p class="c11"><span class="c2">      ; sobre o pino RA4/T0CKI</span></p><p class="c11"><span class="c2">      BCF OPTION_REG, T0SE</span></p><p class="c11 c14"><span class="c5"></span></p><ul class="c80 lst-kix_4vkmwbaar27n-0 start"><li><span class="c5">ciclo de instru&ccedil;&atilde;o interna (CLKOUT)</span></li></ul><p class="c11"><span>      </span><span class="c8">BCF OPTION_REG, T0CS</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">H&aacute; tamb&eacute;m uma configura&ccedil;&atilde;o importante que &eacute; a raz&atilde;o (taxa) de incremento do registrador TMR0</p><p class="c11"><span class="c5">O bit PSA do registrador OPTION_REG &eacute; o bit de atribui&ccedil;&atilde;o do Prescaler (Pr&eacute; escala) que pode ser atribuido ao TImer0 ou ao Watchdog Timer (que ser&aacute; visto no episodio 25)</p><p class="c11"><span class="c5">Se o Prescaler n&atilde;o for atribuido ao TImer0, usando a instru&ccedil;&atilde;o</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>      </span><span class="c8">BSF OPTION_REG, PSA</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">o Prescaler ser&aacute; atribuido ao WDT (Watchdog Timer) e a taxa de incremento do registrador TMR0 ser&aacute; de 1:1 [contagem 0x00 at&eacute; 0xFF(255)]</span></p><p class="c11"><span class="c5">Se os Prescaler for atribu&iacute;do ao Timer0 a rela&ccedil;&atilde;o de incremento do registrador TMR0 ser&aacute; baseada na Tabela 1.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="register">Tabela 1</span><span class="c5">- Rela&ccedil;&atilde;o de incremento</span></p><a id="t.053af01dc13882e0de5e7becb5c299c97155b232"></a><a id="t.149"></a><table class="c56"><tbody><tr><td class="c36"><p class="c1"><span class="c26">PS2</span></p></td><td class="c36"><p class="c1"><span class="c26">PS1</span></p></td><td class="c36"><p class="c1"><span class="c26">PS0</span></p></td><td class="c36"><p class="c1"><span class="c26">TAXA TMR0</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1:2</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1:4</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1:8</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1:16</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1:32</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1:64</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">0</span></p></td><td class="c36"><p class="c1"><span class="c5">1:128</td>
</tr>
<tr><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1</span></p></td><td class="c36"><p class="c1"><span class="c5">1:256</span></p></td></tr></tbody></table><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span>Assim, por exemplo, se PS&lt;2:0&gt; = 001 e T0CS = 1, a cada 4 pulsos no pino RA4/T0CKI h&aacute; o incremento de 1 unidade no registrador TMR0. Agora se PS&lt;2:0&gt; = 110 e T0CS = 1, a cada 120 pulsos no pino RA4/T0CKI h&aacute; o incremento de 1 unidade no registrador TMR0, assim pode-se contar valor de </span><span class="c39">0 at&eacute; 128*255 itens completos</span><span class="c5">.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">O acionamento da interrup&ccedil;&atilde;o associado ao Timer0 se d&aacute; pelo estouro (passagem do valor de 0xFF,equivalente a 255, para o valor 0x00) do registrador TMR0 e a ativava&ccedil;&atilde;o desta interrup&ccedil;&atilde;o se d&aacute; pelos bits GIE e T0IE do registrador INTCON conforme Figura 1</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 604.72px; height: 198.67px;"><img src="images/image47.png" style="width: 604.72px; height: 198.67px;" title=""></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">O bit/flag T0IF do registrador INTCON d&aacute; o estado da interrup&ccedil;&atilde;o, onde se ao ler o estado do bit/flag T0IF for igual a 1, houve um estouro do registrador TMR0, caso T0IF for igual a 0, n&atilde;o houve um estouro no registrador TMR0.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Seja o circuito eletr&ocirc;nico da Figura 2 no qual tem a fun&ccedil;&atilde;o de contagem de objetos/pessoas ao passar pelo sensor fotoeletronico.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c12"><span class="c42 c39 c34 c50">COLOCAR AQUI O DESENHO DO CIRCUITO</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c5">Neste exemplo queremos contar a quantidade de 37 objetos/pessoas ao passar pelo sensor. Ao obter a quantidade desejada o led ligado ao pino RB3 deve ser ligado e reiniciado a contagem</p><p class="c11"><span class="c5">O led permanecer&aacute; verde at&eacute; termos o 1&ordm; objeto/pessoa passad(a) pelo sensor novamente.</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11"><span class="c2">..</p><p class="c11"><span class="c2">ORG 0x00</span></p><p class="c11"><span class="c2">  GOTO setup</span></p><p class="c11"><span class="c2">ORG 0x04</span></p><p class="c11"><span class="c2">  BTFSC INTCON, T0IF ; testa se interrupcao ocorreu por causa de Timer0</span></p><p class="c11"><span class="c2">  GOTO tratamento_Timer_0 ; se sim, salta p/ tratamento Timer0</span></p><p class="c11"><span class="c2">  GOTO sai_interrupcao</span></p><p class="c11"><span class="c2">tratamento_Timer_0:</span></p><p class="c11"><span class="c2">  BCF  INTCON, T0IF    ; desliga flag</span></p><p class="c11"><span class="c2">  MOVLW .219        ; 256 - 37 = 219</span></p><p class="c11"><span class="c2">  MOVWF TMR0        ; atualiza TMR0</span></p><p class="c11"><span class="c2">  BSF  PORTB, RB3     ; liga led em RB3 - quantidade satisfeita</span></p><p class="c11"><span class="c2">  BCF  PORTB, RB2     ; desliga led em RB2</span></p><p class="c11"><span class="c2">  CLRW           ; limpa registrador W</span></p><p class="c11"><span class="c2">  GOTO sai_interrupcoes</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">...</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">setup:</span></p><p class="c11"><span class="c2">  BCF STATUS, RP1 ; episodio 3 - selecao de banco de memoria 1</span></p><p class="c11"><span class="c2">  BsF STATUS, RP0 ; episodio 3 - selecao de banco de memoria 1</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  BSF OPTION_REG, T0CS ; fonte de incremento externo no pino RA4/T0CKI</span></p><p class="c11"><span class="c2">  BCF OPTION_REG, T0SE ; incremento na transicao de nivel baixa </span></p><p class="c11"><span class="c2">             ; para alto no pino RA4/T0CKI</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  BSF OPTION_REG, PSA ; Prescaler nao atribuido ao Timer0,</span></p><p class="c11"><span class="c2">             ; entao a relacao eh 1:1</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  BSF PORTA, RA4 ; episodio 4 - RA4 eh um pino de entrada</span></p><p class="c11"><span class="c2">  BCF PORTB, RB2 ; episodio 4 - RB2 eh um pino de saida</span></p><p class="c11"><span class="c2">  BCF PORTB, RB3 ; episodio 4 - RB3 eh um pino de saida</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  BCF STATUS, RP0 ; selecao do banco de memoria 0</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  MOVLW .219  ; 256 - 37 = 219</span></p><p class="c11"><span class="c2">  MOVWF TMR0 ; atualiza o registrador TMR0</span></p><p class="c11"><span class="c2">  </span></p><p class="c11"><span class="c2">  BSF PORTB, RB2; liga led de estado de n&atilde;o completo a contagem</span></p><p class="c11"><span class="c2">  BcF PORTB, RB3; desliga led de estado de completo a contagem</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  MOVLW 0x07   ; 0x07 = 0000.0111 (desliga modulo comparador)</span></p><p class="c11"><span class="c2">  MOVWF CMCON  ; episodio 20 - desligando o modulo comparador</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  BSF INTCON, T0IE ; ativa a interrupcao do Timer0</span></p><p class="c11"><span class="c2">  BSF INTCON, GIE ; ativa a chave geral das interrupcoes</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  CLRW</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">main:</span></p><p class="c11"><span class="c2">  XORWF  TMR0, 0  ; se igual, z=1, senao z=0</span></p><p class="c11"><span class="c2">  BTFSC  STATUS, Z</span></p><p class="c11"><span class="c2">  GOTO  main</span></p><p class="c11"><span class="c2">  BSF   PORTB, RB2</span></p><p class="c11"><span class="c2">  BCF   PORTB, RB3</span></p><p class="c11"><span class="c2">  GOTO  main</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c11"><span class="c2">  END</span></p><p class="c11 c14"><span class="c2"></span></p><p class="c12"><span class="c39 c34">COMENTAR SOBRE USO DE TIMER0 SEM USO DA INTERRUP&Ccedil;&Atilde;O</span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><p class="c11 c14"><span class="c5"></span></p><hr style="page-break-before:always;display:none;">